# Dredd

"I _am_ the law!" â¸»[Judge Dredd](https://en.wikipedia.org/wiki/Judge_Dredd)

This is a GHC Plugin that, during compilation, automatically builds a
[hedgehog-classes](https://github.com/hedgehogqa/haskell-hedgehog-classes) test
suite for the instances defined in each module.

## Usage

You need to add this plugin to any library you want to test, then you have to
add a corresponding test suite. Here is a cabal example:

```
name:                  my-library

library
  ...
  ghc-options:         -fplugin Dredd

test-suite my-test
  build-depends:       base,
                       my-library,
                       hedgehog-classes,
                       test-lib
  default-language:    Haskell2010
  hs-source-dirs:      dredd
  main-is:             Judge/Dredd.hs          -- you have to write this one
  other-modules:       Judge.Dredd.My.Test.Mod -- this is autogenerated
  type:                exitcode-stdio-1.0
```
`Judge/Dredd.hs` should look like

```haskell
module Main (main) where

import Data.Functor (void)
import Hedgehog.Classes
import qualified Judge.Dredd.My.Test.Mod

main :: IO ()
main =
  void . lawsCheckMany
  $ mconcat
  -- this list should refer to all of the generated modules
  [Judge.Dredd.My.Test.Mod.dreddLaws]
```

## Caveats

Currently, it expects things to be named in a particular way:

```haskell
module MyModule where

instance MyTypeClass MyType
```
will generate a test module that looks like
```haskell
module Test.Dredd.MyModule (dreddLaws) where

import Hedgehog.Classes
import MyModule
import MyModule.Gen

dreddLaws :: [(String, [Laws])]
dreddLaws =
  [ ("MyType", [myTypeClassLaws genMyType]),
    ...
  ]
```
and there should be a driver that builds something like
```haskell
module Test.Dredd (main) where

import Hedgehog.Classes
import qualified Test.Dredd.MyModule

main = void $ lawsCheckMany (Test.Dredd.MyModule.dreddLaws <> ...)
```

## ToDo

- autogenerate the driver, akin to [tasty-discover](https://git.coop/decentral1se/tasty-discover)
- omit tests that aren't satisfied (e.g., most `Laws` require `Eq` and `Show` instances, and we shouldn't generate tests for types that are missing those instances (or maybe create orphan standalone deriving instances in the generated test suite)
- support parameterized instances (e.g., `Monoid a => Monoid (Maybe a)`), perhaps using [Exemplar](https://github.com/matt-noonan/exemplar)
- allow configuration of names and locations for `Laws` and `Gen`s.
